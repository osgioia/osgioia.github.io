name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ Detecta cambios correctamente
      - name: Check for changes
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected; forcing rebuild"
            echo "react_changed=true" >> "$GITHUB_OUTPUT"
            echo "blog_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-list --max-parents=0 "$HEAD_SHA")"
          fi

          echo "Comparing $BASE_SHA to $HEAD_SHA"

          DIFF_OUTPUT="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"

          if echo "$DIFF_OUTPUT" | grep -E '^(src/|public/|package\.json|tailwind\.js|postcss\.config\.js)' > /dev/null; then
            echo "react_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "react_changed=false" >> "$GITHUB_OUTPUT"
          fi

          if echo "$DIFF_OUTPUT" | grep -E '^blog/' > /dev/null; then
            echo "blog_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "blog_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug outputs
        run: |
          echo "React changed: ${{ steps.changes.outputs.react_changed }}"
          echo "Blog changed: ${{ steps.changes.outputs.blog_changed }}"

      # ✅ Cache de dependencias (no del build)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"
          bundler-cache: true
          working-directory: ./blog

      # ✅ Instala dependencias de React solo si cambió
      - name: Install React dependencies
        if: steps.changes.outputs.react_changed == 'true'
        run: npm ci

      # ✅ Compila siempre si cambió algo (sin usar cache viejo)
      - name: Build React portfolio
        if: steps.changes.outputs.react_changed == 'true'
        run: |
          npm run build:css
          npm run build

      # ✅ Instala dependencias de Jekyll solo si cambió algo del blog
      - name: Install Jekyll dependencies
        if: steps.changes.outputs.blog_changed == 'true'
        run: |
          cd blog
          bundle config set path 'vendor/bundle'
          bundle install

      - name: Build Jekyll blog
        if: steps.changes.outputs.blog_changed == 'true'
        run: |
          cd blog
          bundle exec jekyll build --config _config.yml,_config_production.yml --destination ../_site/blog
        env:
          JEKYLL_ENV: production

      # ✅ Prepara la carpeta final
      - name: Prepare deployment directory
        run: |
          mkdir -p _site

          # Copiar build de React
          if [ -d "build" ]; then
            cp -r build/* _site/
            echo "✅ React build copiado a _site"
          else
            echo "⚠️ React build no encontrado (quizás no hubo cambios)"
          fi

          # Verificar blog
          if [ -d "_site/blog" ]; then
            echo "✅ Blog build encontrado en _site/blog"
          else
            echo "⚠️ Blog build no encontrado (quizás no hubo cambios)"
          fi

      # ✅ Deploya siempre lo más nuevo
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          cname: osgioia.dev
